{"title":"Air 724 Cat.1使用经历","date":"2020-06-19T10:45:32.000Z","date_formatted":{"ll":"2020年6月19日","L":"2020/06/19","MM-DD":"06-19"},"link":"2020/06/19/Air-724-Cat-1使用经历","comments":true,"tags":["Air724 Lua Cat.1"],"updated":"2020-10-21T03:54:44.140Z","content":"<a id=\"more\"></a>\n\n<h2 id=\"一、简述\">一、简述<a href=\"#一、简述\" title=\"一、简述\"></a></h2><p>&nbsp;&nbsp;&nbsp;&nbsp;实习期间，从学习Axure，到跟踪进度，再到破解协议，没有一项做成。最后做回老本写写Lua，才感觉我实习不是在划水。接到的任务是将现有老人机从2G短信模式转化为4G Cat.1模式。从4月初开始学习 Cat.1，不过做熟悉的东西的感觉真好。但是在这过程中遇到好多问题，有解决的、有未解决的，每一天都很充实，很感激杜老师的细心教导。</p>\n<p><strong>1.1 功能介绍</strong></p>\n<ol><li>一键紧急呼叫</li><li>4G高清通话</li><li>定时语音提醒</li><li>WiFi定位、网络定位</li><li>微信、APP配置</li><li>电话防骚扰模式</li><li>支持在线升级</li></ol><p><strong>1.2 程序流程图</strong></p>\n<p><img src=\"/2020/06/19/Air-724-Cat-1%E4%BD%BF%E7%94%A8%E7%BB%8F%E5%8E%86/SK121P-4G程序流程图1.1-1592533217974.png\" class=\"φcy\" alt=\"SK121P-4G程序流程图1.1\"></p>\n<h2 id=\"二、开发板介绍\">二、开发板介绍<a href=\"#二、开发板介绍\" title=\"二、开发板介绍\"></a></h2><p><strong>2.1 板子外观</strong></p>\n<p><img src=\"/2020/06/19/Air-724-Cat-1%E4%BD%BF%E7%94%A8%E7%BB%8F%E5%8E%86/板子外观.jpg\" class=\"φcy\" alt=\"板子外观\"></p>\n<p><strong>2.2 开发板烧写</strong></p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp; Cat.1使用的烧录工具是<a href=\"http://www.openluat.com/Product/file/luatoolsV2-redirect.html\" target=\"_blank\">Luatools_v2.exe</a>，使用方法类似4G Cat.4的Luatools.exe。但是比Air 720 4G产品多了一个USB_BOOT–==USB下载模式==。</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;下载方式：</p>\n<ul><li>提前拨动开发板的拨动开发到on，长按开机键直到PWR灯亮</li><li>Luatools_v2.exe中，选好固件版本，添加好lib库和用户脚本后</li><li>点击【下载底层和脚本】，选中【USB BOOT下载】</li><li>按住开发板U_BOOT按键，并按一下重启按键，就可以看到下载进度条开始了。</li><li>注：手动添加lib就不勾选【添加默认lib】</li><li>不加天线会导致拨号、WiFi信号获取失败</li></ul><h2 id=\"三、重点问题\">三、重点问题<a href=\"#三、重点问题\" title=\"三、重点问题\"></a></h2><p><strong>3.1 掉电数据不保存</strong></p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;官方有提供nvm的demo，nvm能够实现小数据量掉电保存，数据存储在.lua的文件中，开机需要初始化，测试发现，如果没有写require”nvm”会导致nvm操作失败。还有一点比较玄学，当定义两个table在global.lua文件中，一个空表a，一个默认配置表b，开机将b复制到a，当存储服务器修改后的配置在a表和b表的相关配置都修改。 <a href=\"https://ask.openluat.com/article/927\" target=\"_blank\">掉电保存nvm合宙说明</a></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span> <span class=\"string\">\"nvm\"</span>  <span class=\"comment\">-- 不能缺</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>开机初始化</strong></p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">require\"nvm\"</span><br><span class=\"line\">require\"config\"</span><br><span class=\"line\"></span><br><span class=\"line\">nvm.init(\"config.lua\")</span><br><span class=\"line\"></span><br><span class=\"line\">-- 保存配置</span><br><span class=\"line\">function p_cfgc_save_config()</span><br><span class=\"line\">    local bool = nvm.set(\"g_cfgc_config\", global.g_cfgc_config)</span><br><span class=\"line\">end</span><br><span class=\"line\"></span><br><span class=\"line\">-- 恢复出厂设置，使用时一定要require\"nvm\"</span><br><span class=\"line\">nvm.restore()</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>config.lua</strong></p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">module(...)</span><br><span class=\"line\"></span><br><span class=\"line\">bootNum        = 1</span><br><span class=\"line\">devStart       = false</span><br><span class=\"line\">g_cfgc_config  ={a}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>3.2 socket创建一直失败，用本地IP，用TCP-UDP工具监测</strong></p>\n<p>​    &nbsp;&nbsp;&nbsp;&nbsp;socket创建需要公网IP，不能连接局域网，用Air 720就遇到过，解决后又忘了这一点。</p>\n<p><strong>3.3  TTS与通话冲突</strong></p>\n<p>​    &nbsp;&nbsp;&nbsp;&nbsp;TTS播放结束后进行打电话，利用TTS播放回调函数：</p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 回调函数</span></span><br><span class=\"line\"><span class=\"keyword\">local</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">testCb</span><span class=\"params\">(r)</span></span></span><br><span class=\"line\">    clog.info(<span class=\"string\">\"tesCall.ready\"</span>..global.g_call_number)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">\t\tcc.dial(global.g_call_number)</span><br><span class=\"line\">\t\tclog.info(<span class=\"string\">\"testAudio.testCb CALLING\"</span>,r)</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\">audio.play(<span class=\"number\">7</span>, <span class=\"string\">\"TTS\"</span>, tts_str, <span class=\"number\">4</span>, testCb)</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>3.4  在其他文件调用发送数据给服务器函数报错</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[E]-[coroutine.<span class=\"built_in\">resume</span>] /lua/socket.lua:<span class=\"number\">277</span>: socket:send: coroutine mismatch</span><br><span class=\"line\">stack <span class=\"built_in\">traceback</span>:</span><br><span class=\"line\">        [C]: <span class=\"keyword\">in</span> <span class=\"function\"><span class=\"keyword\">function</span> '<span class=\"title\">assert</span>'</span></span><br><span class=\"line\"><span class=\"function\">        /<span class=\"title\">lua</span>/<span class=\"title\">socket.lua</span>:277: <span class=\"title\">in</span> <span class=\"title\">function</span> '<span class=\"title\">send</span>'</span></span><br><span class=\"line\"><span class=\"function\">        /<span class=\"title\">lua</span>/<span class=\"title\">netproc.lua</span>:49: <span class=\"title\">in</span> <span class=\"title\">function</span> '<span class=\"title\">p_netc_send</span>'</span></span><br><span class=\"line\"><span class=\"function\">        /<span class=\"title\">lua</span>/<span class=\"title\">netproc.lua</span>:177: <span class=\"title\">in</span> <span class=\"title\">function</span> '<span class=\"title\">fast_send</span>'</span></span><br><span class=\"line\"><span class=\"function\">        /<span class=\"title\">lua</span>/<span class=\"title\">location.lua</span>:104: <span class=\"title\">in</span> <span class=\"title\">function</span> &lt;/<span class=\"title\">lua</span>/<span class=\"title\">location.lua</span>:88&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不知道为什么出现这个问题，之后改成在哪个文件创建的发送数据函数，就在哪个文件中发送数据，才不会遇到这个问题，在其他文件调用，或者是回调中调用都会出现这个问题。</p>\n<p><strong>3.5  在其他文件调用发送数据给服务器函数报错</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"number\">2020</span><span class=\"number\">-05</span><span class=\"number\">-13</span> <span class=\"number\">11</span>:<span class=\"number\">07</span>:<span class=\"number\">38.976</span>] [W]-[lbsLoc.query] 根据基站查询经纬度失败</span><br><span class=\"line\">[<span class=\"number\">2020</span><span class=\"number\">-05</span><span class=\"number\">-13</span> <span class=\"number\">11</span>:<span class=\"number\">07</span>:<span class=\"number\">38.986</span>] [W]-[lbsLoc.query] main.lua中的PRODUCT_KEY和此设备在iot.openluat.com中所属项目的ProductKey必须一致，请去检</span><br><span class=\"line\">[<span class=\"number\">2020</span><span class=\"number\">-05</span><span class=\"number\">-13</span> <span class=\"number\">11</span>:<span class=\"number\">07</span>:<span class=\"number\">38.986</span>] 查</span><br><span class=\"line\">[<span class=\"number\">2020</span><span class=\"number\">-05</span><span class=\"number\">-13</span> <span class=\"number\">11</span>:<span class=\"number\">07</span>:<span class=\"number\">38.986</span>] [I]-[testLbsLoc.getLocCb] <span class=\"number\">5</span> <span class=\"literal\">nil</span> <span class=\"literal\">nil</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><a href=\"https://iot.openluat.com/\" target=\"_blank\">&nbsp;&nbsp;&nbsp;&nbsp;Luat物联云平台</a>中的PRODUCT_KEY和main.lua中的PRODUCT_KEY不一致。</p>\n<p><strong>3.5  更新报错</strong></p>\n<figure class=\"highlight plain\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">已经是最新版</span><br></pre></td></tr></tbody></table></figure>\n\n<ol><li><p>只有脚本没有固件</p></li><li><p>设备脚本和固件版本没有比云平台的低</p></li><li><p>云平台中设备imei号码没有添加到升级文件下</p></li><li><p>main.lua版本号写错了，如：</p></li></ol><figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PROJECT = <span class=\"string\">\"SK-122-4G\"</span></span><br><span class=\"line\">VERSION = <span class=\"string\">\"1.1.9\"</span>   <span class=\"comment\">--正确 一位数</span></span><br><span class=\"line\"></span><br><span class=\"line\">PROJECT = <span class=\"string\">\"SK-122-4G\"</span></span><br><span class=\"line\">VERSION = <span class=\"string\">\"1.1.90\"</span>   <span class=\"comment\">--错误 非一位数</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>3.6  更新主动权在用户手上，不主动请求更新</strong></p>\n<p><strong>代码编写</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span> <span class=\"string\">\"update\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> 收到用户更新请求 <span class=\"keyword\">then</span></span><br><span class=\"line\">\t update.request(update_cbFnc)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>Luat物联云平台设置</strong></p>\n<p><img src=\"/2020/06/19/Air-724-Cat-1%E4%BD%BF%E7%94%A8%E7%BB%8F%E5%8E%86/云平台升级设置.png\" class=\"φcy\" alt=\"云平台升级设置\"></p>\n<p><strong>升级失败解决方法</strong></p>\n<ul><li>官网<a href=\"https://ask.openluat.com/article/916\" target=\"_blank\">合宙升级提示</a></li></ul><p><strong>3.7  开发板拨号失败</strong></p>\n<ol><li><p>没有插天线</p></li><li><p>联通卡没开通VOLTE通话：</p><p>&nbsp;&nbsp;客户短信开通/退订方式：开通：DGVOLTE至10010；退订：TDVOLTE至10010</p></li></ol><p><strong>3.8  时间获取</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- ntp获取时间</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p_tts_now_time</span><span class=\"params\">()</span></span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> now_tts</span><br><span class=\"line\">    <span class=\"keyword\">local</span> now_time = <span class=\"built_in\">os</span>.<span class=\"built_in\">date</span>(<span class=\"string\">\"*t\"</span>)</span><br><span class=\"line\">    now_tts =  global.g_tts_default.now_time..<span class=\"built_in\">tostring</span>(now_time[<span class=\"string\">\"hour\"</span>])..<span class=\"string\">\"点\"</span>..<span class=\"built_in\">tostring</span>(now_time[<span class=\"string\">\"min\"</span>])..<span class=\"string\">\"分\"</span></span><br><span class=\"line\">    audio.play(<span class=\"number\">6</span>, <span class=\"string\">\"TTS\"</span>, now_tts, global.g_tts_volume)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"comment\">-- 基站获取时间 联通不准</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p_tts_now_time</span><span class=\"params\">()</span></span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> now_tts</span><br><span class=\"line\">    <span class=\"keyword\">local</span> now_time = misc.getClock()</span><br><span class=\"line\">    now_tts =  global.g_tts_default.now_time..<span class=\"built_in\">tostring</span>(now_time[<span class=\"string\">\"hour\"</span>])..<span class=\"string\">\"点\"</span>..<span class=\"built_in\">tostring</span>(now_time[<span class=\"string\">\"min\"</span>])..<span class=\"string\">\"分\"</span></span><br><span class=\"line\">    audio.play(<span class=\"number\">6</span>, <span class=\"string\">\"TTS\"</span>, now_tts, global.g_tts_volume)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></tbody></table></figure>\n\n\n\n<h2 id=\"四、常用知识点\">四、常用知识点<a href=\"#四、常用知识点\" title=\"四、常用知识点\"></a></h2><p><strong>4.1  电压剩余指标</strong></p>\n<p><img src=\"/2020/06/19/Air-724-Cat-1%E4%BD%BF%E7%94%A8%E7%BB%8F%E5%8E%86/电压指标.jpg\" class=\"φcy\" alt=\"电压指标\"></p>\n<p>电压:4.16-4.22V涓流补充:100%</p>\n<p><strong>4.2  table和数组的区别</strong></p>\n<ol><li><p>数组的key只能是数字，table的key可以是数字或者字符串，table中还能嵌入table</p></li><li><p>table是个对象，可以想成一种动态分配的对象</p></li><li><p>ipairs和pairs的区别是有i的ipairs比较有个性，只会按key值升序遍历数组，遇到nil就退出不干了，适用于数组遍历；pairs没有i没有个性，老老实实将所有key遍历，适用于table。一直记不住两者区别，后来发现ipairs比较任性，i有i的想法。</p></li></ol><p><strong>4.3 table按key排序</strong></p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;例：将sort_table的表1-1排序成calling_table表1-2，按key_id是否为空排顺序排序</p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 表1-1</span></span><br><span class=\"line\">TTS             =</span><br><span class=\"line\">    {</span><br><span class=\"line\">        TTS_1       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">        TTS_5       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">        TTS_3       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">    }</span><br><span class=\"line\"><span class=\"comment\">-- 表1-2</span></span><br><span class=\"line\">TTS             =</span><br><span class=\"line\">    {</span><br><span class=\"line\">        TTS_1       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">        TTS_3       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">        TTS_5       =</span><br><span class=\"line\">        {</span><br><span class=\"line\">            <span class=\"built_in\">time</span>            = <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        },</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p_call_table_sort</span><span class=\"params\">( sort_table, calling_table ,key_id)</span></span></span><br><span class=\"line\">    <span class=\"keyword\">local</span> key_test ={}</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i, v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(sort_table) <span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> v[key_id] ~= <span class=\"string\">\"\"</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">table</span>.<span class=\"built_in\">insert</span>(key_test,i)   <span class=\"comment\">--提取test1中的键值插入到key_test表中</span></span><br><span class=\"line\">            <span class=\"comment\">--clog.warning(\"p_call_table_sort:\"..i)</span></span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"built_in\">table</span>.<span class=\"built_in\">sort</span>(key_test)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i,v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(key_test) <span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"built_in\">table</span>.<span class=\"built_in\">insert</span>(calling_table,sort_table[v])</span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>4.3 批量操作</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- data支持批量操作，保存全部的信息</span></span><br><span class=\"line\">                <span class=\"keyword\">for</span> i,value <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(real_data.data) <span class=\"keyword\">do</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> value[<span class=\"string\">\"type\"</span>] == <span class=\"number\">1</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                        <span class=\"keyword\">local</span> phone_id = <span class=\"string\">\"phone_\"</span>..<span class=\"built_in\">tostring</span>(value[<span class=\"string\">\"id\"</span>])</span><br><span class=\"line\">                        clog.warning(<span class=\"string\">\"更新通信录1:\"</span>..phone_id..value[<span class=\"string\">\"name\"</span>]..value[<span class=\"string\">\"phone\"</span>])</span><br><span class=\"line\">                        global.g_cfgc_config.phone[phone_id][<span class=\"string\">\"name\"</span>]           = value[<span class=\"string\">\"name\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.phone[phone_id][<span class=\"string\">\"phone\"</span>]          = value[<span class=\"string\">\"phone\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.phone[phone_id][<span class=\"string\">\"dialmode\"</span>]       = value[<span class=\"string\">\"dialmode\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.phone[phone_id][<span class=\"string\">\"type\"</span>]           = <span class=\"number\">1</span></span><br><span class=\"line\">                    <span class=\"keyword\">elseif</span> value[<span class=\"string\">\"type\"</span>] == <span class=\"number\">2</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                        <span class=\"keyword\">local</span> phone_id = <span class=\"string\">\"Whitlst_\"</span>..<span class=\"built_in\">tostring</span>(value[<span class=\"string\">\"id\"</span>])</span><br><span class=\"line\">                        clog.warning(<span class=\"string\">\"更新通信录2:\"</span>..phone_id..value[<span class=\"string\">\"name\"</span>]..value[<span class=\"string\">\"phone\"</span>])</span><br><span class=\"line\">                        global.g_cfgc_config.Whitlst[phone_id][<span class=\"string\">\"name\"</span>]           = value[<span class=\"string\">\"name\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.Whitlst[phone_id][<span class=\"string\">\"phone\"</span>]          = value[<span class=\"string\">\"phone\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.Whitlst[phone_id][<span class=\"string\">\"dialmode\"</span>]       = value[<span class=\"string\">\"dialmode\"</span>]</span><br><span class=\"line\">                        global.g_cfgc_config.Whitlst[phone_id][<span class=\"string\">\"type\"</span>]           = <span class=\"number\">2</span></span><br><span class=\"line\">                    <span class=\"keyword\">end</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>4.5  固定TTS播放</strong></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">local</span> now_time = p_timing_now_time()</span><br><span class=\"line\">    <span class=\"keyword\">local</span> week = misc.getWeek()</span><br><span class=\"line\">    <span class=\"comment\">-- 只有在接收服务器更新的时候排序</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> tts_update == <span class=\"literal\">true</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        tts_table  = {}</span><br><span class=\"line\">        tools.p_call_table_sort( global.g_cfgc_config.TTS, tts_table,<span class=\"string\">\"text\"</span> )</span><br><span class=\"line\">        tts_update = <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"comment\">--clog.error(\"tts_table\"..#tts_table)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>  #tts_table ~= <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> i, v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(tts_table) <span class=\"keyword\">do</span></span><br><span class=\"line\">            <span class=\"keyword\">local</span> week_t = <span class=\"built_in\">tonumber</span>(v[<span class=\"string\">\"week\"</span>])</span><br><span class=\"line\">            <span class=\"keyword\">for</span> j=<span class=\"number\">1</span>,<span class=\"number\">7</span> <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"keyword\">local</span> flag = bit.isset( week_t, j )</span><br><span class=\"line\">                <span class=\"comment\">--clog.warning(j..\":j flag:\"..tools.true2int(flag))</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> flag == <span class=\"literal\">true</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                    <span class=\"comment\">-- 判断提醒的是周几 </span></span><br><span class=\"line\">                    <span class=\"built_in\">table</span>.<span class=\"built_in\">insert</span>( tts_week, j, j )</span><br><span class=\"line\">                    <span class=\"comment\">--clog.warning(j..\":tts_week:\"..tts_week[j])</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"comment\">-- 今天是是否有提醒</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> tts_week[week] ~= <span class=\"literal\">nil</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>  v[<span class=\"string\">\"time\"</span>] == now_time <span class=\"keyword\">then</span></span><br><span class=\"line\">                    clog.<span class=\"built_in\">error</span>(v[<span class=\"string\">\"time\"</span>]..<span class=\"string\">\"v[time] and now_time :\"</span>..now_time..<span class=\"string\">\"global week:\"</span>..week_t..week)</span><br><span class=\"line\">                    audio.play(<span class=\"number\">7</span>, <span class=\"string\">\"TTS\"</span>, v[<span class=\"string\">\"text\"</span>], global.g_tts_volume)</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> v[<span class=\"string\">\"repeated\"</span>] == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                        tts_count = tts_count + <span class=\"number\">1</span></span><br><span class=\"line\">                    <span class=\"keyword\">end</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">                 <span class=\"comment\">-- 若为提醒完 并且配置为不重复 </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> tts_count &gt; <span class=\"number\">4</span> <span class=\"keyword\">and</span> v[<span class=\"string\">\"repeated\"</span>] == <span class=\"number\">0</span> <span class=\"keyword\">then</span></span><br><span class=\"line\">                    tts_count = <span class=\"number\">0</span></span><br><span class=\"line\">                    <span class=\"keyword\">local</span> num = bit.clear( <span class=\"built_in\">tonumber</span>(v[<span class=\"string\">\"week\"</span>]), week)</span><br><span class=\"line\">                    v[<span class=\"string\">\"week\"</span>] = <span class=\"built_in\">tostring</span>(num)</span><br><span class=\"line\">                    <span class=\"comment\">--clog.debug(num..\":num and v[week]:\"..v[\"week\"])</span></span><br><span class=\"line\">                    main_proc.p_cfgc_save_config()</span><br><span class=\"line\">                    tts_update = <span class=\"literal\">true</span></span><br><span class=\"line\">                <span class=\"keyword\">end</span></span><br><span class=\"line\">            <span class=\"keyword\">end</span></span><br><span class=\"line\">           </span><br><span class=\"line\">        <span class=\"keyword\">end</span></span><br><span class=\"line\">    <span class=\"keyword\">end</span></span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"五、学习链接\">五、学习链接<a href=\"#五、学习链接\" title=\"五、学习链接\"></a></h2><p>5.1  <a href=\"https://www.json.cn/\" target=\"_blank\">JSON在线解析</a></p>\n<p>5.2  <a href=\"https://cli.im/\" target=\"_blank\">草料二维码在线生成</a></p>\n<p>5.3  <a href=\"https://tool.lu/hexstr/\" target=\"_blank\">HEX字符串互相转换</a></p>\n<p>5.4  <a href=\"https://ask.openluat.com/article/927\" target=\"_blank\">掉电保存nvm</a></p>\n<figure class=\"highlight lua\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span> <span class=\"string\">\"nvm\"</span>  <span class=\"comment\">-- 不能缺</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>5.5 <a href=\"https://www.sojson.com/json2xml/\" target=\"_blank\">xml转json</a></p>\n<p>5.6  <a href=\"https://ask.openluat.com/article/916\" target=\"_blank\">合宙升级提示</a></p>\n<p>5.7  <a href=\"https://ask.openluat.com/article/1082\" target=\"_blank\">724UG抓取AP日志</a></p>\n","prev":{"title":"LabVIEW Notes","link":"2020/06/20/LabVIEW-Notes"},"next":{"title":"合宙Lua开发资料汇总","link":"2020/05/29/合宙Lua开发资料汇总"},"plink":"http://yoursite.com/2020/06/19/Air-724-Cat-1使用经历/"}